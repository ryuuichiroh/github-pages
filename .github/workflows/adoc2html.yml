name: Convert Asciidoc to HTML and Deploy

on:
  push:
    branches: [main]
    paths: ["docs/**/*"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Asciidoctor
        run: |
          sudo apt-get update
          sudo apt-get install -y asciidoctor

      - name: AsciiDoc to HTML conversion
        run: |
          # CSSファイルをdocsディレクトリにコピー
          cp .github/styles/custom-asciidoc.css docs/

          # Docinfoファイルもコピー
          cp .github/scripts/docinfo.html docs/

          # adocファイルが存在する場合のみ変換を実行
          if ls docs/**/*.adoc 1> /dev/null 2>&1; then
            for file in docs/**/*.adoc; do
              # ディレクトリ構造を保持したまま .adoc を .html に変更
              htmlfile="${file%.adoc}.html"
              echo "Converting $file to $htmlfile"
              asciidoctor -a linkcss \
                -a stylesdir=. \
                -a stylesheet=custom-asciidoc.css \
                -a docinfo=shared \
                -a docinfodir=. \
                -o "$htmlfile" "$file"
            done
          else
            echo "No .adoc files found to convert"
          fi

      - name: Add Mermaid support
        run: |
          # HTMLファイルにMermaidサポートを追加
          for htmlfile in docs/**/*.html; do
            if [ -f "$htmlfile" ]; then
              # Mermaidサポートを追加
              sed -i '/<\/head>/r .github/scripts/mermaid-support.html' "$htmlfile"
              sed -i '/<\/head>/d' "$htmlfile"
            fi
          done

      - name: List files to be deployed
        run: |
          echo "Files that will be deployed to GitHub Pages:"
          find docs -type f | sort

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3.0.1
        with:
          path: docs

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
