<!-- Mermaid Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  mermaid.initialize({startOnLoad: false, theme: "default"});
  
  console.log("Mermaid script loaded");
  
  // AsciiDocのMermaidブロックを検索
  const literalBlocks = document.querySelectorAll(".literalblock");
  let index = 0;
  
  literalBlocks.forEach(block => {
    const content = block.querySelector(".content pre");
    if (content) {
      const text = content.textContent.trim();
      console.log("Found literal block:", text.substring(0, 50));
      
      // Mermaidコードかどうかを判定（CSSや既に変換されたSVGは除外）
      if ((text.startsWith("flowchart") || text.startsWith("graph") || 
          text.startsWith("sequenceDiagram") || text.startsWith("classDiagram") || 
          text.startsWith("stateDiagram") || text.startsWith("journey") || 
          text.startsWith("gantt") || text.startsWith("pie")) &&
          !text.includes("#diagram-") && !text.includes("font-family")) {
        
        console.log("Converting to Mermaid:", text.substring(0, 50));
        
        const div = document.createElement("div");
        div.className = "mermaid";
        div.id = "mermaid-" + index;
        
        mermaid.render("diagram-" + index, text).then(result => {
          div.innerHTML = result.svg;
          block.parentNode.replaceChild(div, block);
          console.log("Mermaid rendered successfully");
        }).catch(error => {
          console.error("Mermaid rendering failed:", error);
          div.innerHTML = "<p style='color: red;'>Mermaid rendering failed: " + error.message + "</p>";
          block.parentNode.replaceChild(div, block);
        });
        index++;
      }
    }
  });
  
  // Listingブロックも確認
  const listingBlocks = document.querySelectorAll(".listingblock");
  listingBlocks.forEach(block => {
    const content = block.querySelector(".content pre");
    if (content) {
      const text = content.textContent.trim();
      console.log("Found listing block:", text.substring(0, 50));
      
      // Mermaidコードかどうかを判定（CSSや既に変換されたSVGは除外）
      if ((text.startsWith("flowchart") || text.startsWith("graph") || 
          text.startsWith("sequenceDiagram") || text.startsWith("classDiagram") || 
          text.startsWith("stateDiagram") || text.startsWith("journey") || 
          text.startsWith("gantt") || text.startsWith("pie")) &&
          !text.includes("#diagram-") && !text.includes("font-family")) {
        
        console.log("Converting listing to Mermaid:", text.substring(0, 50));
        
        const div = document.createElement("div");
        div.className = "mermaid";
        div.id = "mermaid-listing-" + index;
        
        mermaid.render("diagram-listing-" + index, text).then(result => {
          div.innerHTML = result.svg;
          block.parentNode.replaceChild(div, block);
          console.log("Mermaid from listing rendered successfully");
        }).catch(error => {
          console.error("Mermaid from listing rendering failed:", error);
          div.innerHTML = "<p style='color: red;'>Mermaid rendering failed: " + error.message + "</p>";
          block.parentNode.replaceChild(div, block);
        });
        index++;
      }
    }
  });
  
  // 既存のmermaidクラスの要素も処理（ただし、SVGや処理済みのものは除外）
  const mermaidElements = document.querySelectorAll('.mermaid');
  mermaidElements.forEach(element => {
    if (!element.dataset.processed && !element.querySelector('svg')) {
      const text = element.textContent.trim();
      if (text && !text.includes("#diagram-") && !text.includes("font-family")) {
        console.log("Processing existing mermaid element:", text.substring(0, 50));
        mermaid.render("existing-" + index, text).then(result => {
          element.innerHTML = result.svg;
          element.dataset.processed = "true";
          console.log("Existing mermaid element processed");
        }).catch(error => {
          console.error("Existing mermaid processing failed:", error);
          element.innerHTML = "<p style='color: red;'>Mermaid rendering failed: " + error.message + "</p>";
        });
        index++;
      }
    }
  });
});
</script>
