<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  mermaid.initialize({startOnLoad: false, theme: "default"});
  
  // AsciiDoc形式のコードブロック (.literalblock, .listingblock)
  const asciidocBlocks = document.querySelectorAll(".literalblock .content, .listingblock .content");
  let index = 0;
  
  asciidocBlocks.forEach(block => {
    const pre = block.querySelector("pre");
    if (pre) {
      const content = pre.textContent.trim();
      // Check if this is a mermaid block by content or by [source,mermaid] or [mermaid] attribute
      const parentBlock = block.closest('.listingblock');
      const isMermaidByTitle = parentBlock?.querySelector('.title')?.textContent.includes('mermaid');
      const isMermaidByContent = content.startsWith("flowchart") || content.startsWith("graph") || 
          content.startsWith("sequenceDiagram") || content.startsWith("classDiagram") || 
          content.startsWith("stateDiagram") || content.startsWith("journey") || 
          content.startsWith("gantt") || content.startsWith("pie");
      
      if (isMermaidByContent || isMermaidByTitle) {
        const div = document.createElement("div");
        div.className = "mermaid";
        div.id = "mermaid-" + index;
        mermaid.render("diagram-" + index, content).then(result => {
          div.innerHTML = result.svg;
          block.parentNode.replaceChild(div, block);
        }).catch(() => {
          div.innerHTML = "<p>Mermaid rendering failed</p>";
          block.parentNode.replaceChild(div, block);
        });
        index++;
      }
    }
  });
  
  // Markdown形式のコードブロック (```mermaid)
  const codeBlocks = document.querySelectorAll("pre code");
  codeBlocks.forEach(codeBlock => {
    const content = codeBlock.textContent.trim();
    if (content.startsWith("flowchart") || content.startsWith("graph") || 
        content.startsWith("sequenceDiagram") || content.startsWith("classDiagram") || 
        content.startsWith("stateDiagram") || content.startsWith("journey") || 
        content.startsWith("gantt") || content.startsWith("pie")) {
      const div = document.createElement("div");
      div.className = "mermaid";
      div.id = "mermaid-md-" + index;
      mermaid.render("diagram-md-" + index, content).then(result => {
        div.innerHTML = result.svg;
        codeBlock.parentNode.parentNode.replaceChild(div, codeBlock.parentNode);
      }).catch(() => {
        div.innerHTML = "<p>Mermaid rendering failed</p>";
        codeBlock.parentNode.parentNode.replaceChild(div, codeBlock.parentNode);
      });
      index++;
    }
  });
});
</script>
