<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= document.doctitle %></title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2, h3, h4, h5, h6 {
      color: #2c3e50;
      margin-top: 2em;
      margin-bottom: 1em;
    }
    h1 {
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      border-bottom: 1px solid #bdc3c7;
      padding-bottom: 5px;
    }
    .listingblock .content {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 1em;
      overflow-x: auto;
    }
    .listingblock pre {
      margin: 0;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    .mermaid {
      text-align: center;
      margin: 2em 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .admonitionblock {
      margin: 1em 0;
      padding: 1em;
      border-left: 4px solid #3498db;
      background-color: #f8f9fa;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, searching for Mermaid blocks...');
      
      // Mermaidを初期化
      mermaid.initialize({ 
        startOnLoad: false, 
        theme: 'default',
        securityLevel: 'loose'
      });
      
      // [mermaid] ブロックを探して変換
      const mermaidBlocks = document.querySelectorAll('.listingblock .content');
      console.log('Found blocks:', mermaidBlocks.length);
      
      let mermaidIndex = 0;
      mermaidBlocks.forEach((block, index) => {
        const pre = block.querySelector('pre');
        if (pre) {
          const content = pre.textContent.trim();
          console.log('Block ' + index + ' content:', content.substring(0, 50) + '...');
          
          if (content.startsWith('flowchart') || 
              content.startsWith('graph') ||
              content.startsWith('sequenceDiagram') ||
              content.startsWith('classDiagram') ||
              content.startsWith('stateDiagram') ||
              content.startsWith('journey') ||
              content.startsWith('gantt') ||
              content.startsWith('pie')) {
            
            console.log('Converting Mermaid block:', index);
            const mermaidCode = pre.textContent.trim();
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.id = `mermaid-diagram-${mermaidIndex}`;
            
            // Mermaidを直接レンダリング
            mermaid.render(`diagram-${mermaidIndex}`, mermaidCode)
              .then(result => {
                mermaidDiv.innerHTML = result.svg;
                block.parentNode.replaceChild(mermaidDiv, block);
              })
              .catch(error => {
                console.error('Mermaid rendering error:', error);
                mermaidDiv.innerHTML = '<p style="color: red;">Mermaid diagram rendering failed</p>';
                block.parentNode.replaceChild(mermaidDiv, block);
              });
            
            mermaidIndex++;
          }
        }
      });
    });
  </script>
</head>
<body>
  <div id="header">
    <% if document.header? %>
    <h1><%= document.doctitle %></h1>
    <% end %>
  </div>
  <div id="content">
    <%= document.content %>
  </div>
  <div id="footer">
    <div id="footer-text">
      Generated on <%= Time.now.strftime('%Y-%m-%d %H:%M:%S') %>
    </div>
  </div>
</body>
</html>
